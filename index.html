<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Care-Pro2 AI | ç¾å ´å®Œå…¨å®Ÿå‹•ãƒ»æœ€çµ‚ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d4af37;
            --bg: #f4f7f9;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .card {
            background: white;
            width: 100%;
            max-width: 550px;
            padding: 25px;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 6px solid var(--accent);
            position: relative;
        }

        .title {
            color: var(--primary);
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sub {
            color: #888;
            font-size: 14px;
            margin-bottom: 25px;
        }

        /* éŸ³å£°å…¥åŠ›ã‚¬ã‚¤ãƒ‰ */
        .guide-box {
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: left;
            font-size: 12px;
            color: #795548;
            line-height: 1.4;
        }

        .guide-box strong {
            color: #ef6c00;
            display: block;
            margin-bottom: 4px;
        }

        .input-group {
            background: #fafafa;
            border: 2px solid #eee;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
        }

        textarea {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 17px;
            min-height: 80px;
            resize: none;
            font-family: inherit;
            color: #333;
            outline: none;
        }

        .controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        .btn {
            border: none;
            border-radius: 18px;
            font-weight: bold;
            cursor: pointer;
            padding: 18px;
            font-size: 16px;
            transition: 0.2s;
        }

        #micBtn {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        #micBtn.active {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        #analyzeBtn {
            background: var(--accent);
            color: white;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        #status {
            margin-top: 15px;
            color: var(--accent);
            font-size: 14px;
            font-weight: bold;
            min-height: 20px;
        }

        .loading {
            display: none;
            margin: 25px 0;
            font-weight: bold;
            color: var(--primary);
        }

        .sol-list {
            display: grid;
            gap: 12px;
            margin-top: 25px;
            text-align: left;
        }

        .sol-item {
            background: #fff;
            border-left: 6px solid var(--accent);
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            font-size: 14px;
            line-height: 1.5;
        }

        .sol-item.selected {
            border-left-color: #27ae60;
            background: #f0fff4;
            border-width: 8px;
        }

        .custom-sol {
            margin-top: 15px;
            background: #fff8e1;
            border: 2px dashed #d4af37;
            border-radius: 18px;
            padding: 15px;
        }

        .custom-sol textarea {
            min-height: 50px;
            font-size: 14px;
            border: none;
            background: transparent;
            width: 100%;
            border-bottom: 1px solid #d4af37;
            margin-bottom: 8px;
            outline: none;
        }

        #historyArea {
            width: 100%;
            max-width: 550px;
            margin-top: 30px;
            display: none;
        }
    </style>
</head>

<body>

    <div class="card">
        <div class="title">Care-Pro2 AI</div>
        <div class="sub">ç¾å ´ã®ã€Œä¸æ³¨æ„ãƒ»è¦‹è½ã¨ã—ã€ã‚’é˜²ãæœ€å¼·ã®è¨˜éŒ²æ”¯æ´</div>

        <!-- é¸æŠå…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
            <div>
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">æ‹…å½“è€…</label>
                <select id="selectUser"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                    <option value="">èª­è¾¼ä¸­...</option>
                </select>
            </div>
            <div>
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">å¯¾è±¡åˆ©ç”¨è€…</label>
                <select id="selectPatient"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                    <option value="">èª­è¾¼ä¸­...</option>
                </select>
            </div>
            <div>
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">å ´æ‰€</label>
                <select id="selectLocation"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                    <option value="">èª­è¾¼ä¸­...</option>
                </select>
            </div>
        </div>

        <!-- éŸ³å£°å…¥åŠ›ã‚¬ã‚¤ãƒ‰ -->
        <div class="guide-box">
            <strong>ğŸ¤ éŸ³å£°å…¥åŠ›ã®ã‚³ãƒ„ï¼ˆäº‹è±¡ã¨ãƒªã‚¹ã‚¯ã‚’æ•™ãˆã¦ãã ã•ã„ï¼‰</strong>
            ã€Œ[ä½•ãŒèµ·ããŸã‹] ï¼‹ [ãªãœå±ãªã‹ã£ãŸã‹/ãªãœèµ·ããŸã‹]ã€ã‚’è©±ã—ã¦ãã ã•ã„ã€‚<br>
            ä¾‹ï¼šè»Šæ¤…å­ã‹ã‚‰ç«‹ã¡ä¸ŠãŒã‚ã†ã¨ã—ã¦ã€è¶³å…ƒãŒæ»‘ã£ã¦è»¢è½ã—ãã†ã«ãªã£ãŸ
        </div>

        <div class="input-group">
            <textarea id="inputText" placeholder="ã“ã“ã«äº‹è±¡ã¨ãƒªã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
        </div>

        <div class="controls">
            <button id="micBtn" class="btn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
            <button id="analyzeBtn" class="btn">è§£æ</button>
        </div>

        <div id="status"></div>
        <div id="loading" class="loading">ã‚¸ã‚§ãƒ¼ãƒ ã‚ºãŒç¾å ´ã®çœŸå®Ÿã‚’åˆ†æä¸­...</div>

        <div id="solArea" style="display:none;">
            <div id="solList" class="sol-list"></div>

            <div class="custom-sol">
                <div style="font-size: 12px; font-weight: bold; color: var(--accent); margin-bottom: 5px;">ğŸ“
                    ç¾å ´ç‹¬è‡ªã®å¯¾ç­–ï¼ˆè‡ªç”±å…¥åŠ›ãƒ»éŸ³å£°å¯ï¼‰</div>
                <textarea id="customSolText" placeholder="ç¾å ´ã§æ±ºã‚ãŸå³å¿œå¯¾ç­–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                <button id="customSendBtn" class="btn"
                    style="width:100%; padding: 10px; background: #27ae60; color: white;">ã“ã®å†…å®¹ã§ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxl9tuNWZB_ukwRMf2KH2uPNuyHhvGvUD7hHAMpVaRaSs1eEVjdd6Vzs66TxBkmr2oPdg/exec';
        const API_KEY = 'app-jCYBv1fEqIbe66K9e63iSt3M';
        const DIFY_URL = 'https://api.dify.ai/v1/chat-messages';

        const micBtn = document.getElementById('micBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const inputText = document.getElementById('inputText');
        const customSolText = document.getElementById('customSolText');
        const customSendBtn = document.getElementById('customSendBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const solArea = document.getElementById('solArea');
        const solList = document.getElementById('solList');
        const selUser = document.getElementById('selectUser');
        const selPatient = document.getElementById('selectPatient');
        const selLocation = document.getElementById('selectLocation');

        let recognition, isRecording = false;

        async function init() {
            renderHistory();
            status.innerText = 'ã‚·ãƒ¼ãƒˆåŒæœŸä¸­...';
            try {
                const res = await fetch(`${GAS_URL}?type=master&t=${Date.now()}`);
                const data = await res.json();
                if (data.users && data.users.length > 0) {
                    updateSelect(selUser, data.users, 'æ‹…å½“è€…');
                    updateSelect(selPatient, data.patients, 'åˆ©ç”¨è€…');
                    updateSelect(selLocation, data.locations, 'å ´æ‰€');
                    status.innerText = 'ã‚·ãƒ¼ãƒˆåŒæœŸå®Œäº†';
                }
            } catch (e) { status.innerText = 'åŒæœŸå¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ›´æ–°ã—ã¦ãã ã•ã„ï¼‰'; }
        }

        function updateSelect(el, list, placeholder) {
            el.innerHTML = `<option value="">${placeholder}</option>`;
            list.forEach(item => {
                const opt = document.createElement('option');
                opt.value = opt.innerText = item;
                el.appendChild(opt);
            });
        }

        function setupRecognition() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) return null;
            const rec = new Speech();
            rec.lang = 'ja-JP'; rec.interimResults = true; rec.continuous = false;
            rec.onstart = () => { isRecording = true; micBtn.classList.add('active'); status.innerText = 'èãå–ã‚Šä¸­...'; };
            rec.onresult = (e) => {
                let t = ''; for (let i = e.resultIndex; i < e.results.length; i++) { t += e.results[i][0].transcript; }
                if (solArea.style.display === 'block') customSolText.value = t; else inputText.value = t;
            };
            rec.onend = () => {
                isRecording = false; micBtn.classList.remove('active');
                if (solArea.style.display !== 'block' && inputText.value.length > 0) analyze();
            };
            return rec;
        }

        micBtn.addEventListener('click', () => {
            if (!recognition) recognition = setupRecognition();
            if (isRecording) recognition.stop(); else recognition.start();
        });

        analyzeBtn.addEventListener('click', () => { if (inputText.value.length > 0) analyze(); });

        async function analyze() {
            loading.style.display = 'block'; solArea.style.display = 'none'; status.innerText = '';
            const text = inputText.value;
            const location = selLocation.value || "ç¾å ´";

            try {
                const response = await fetch(DIFY_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        inputs: {},
                        query: `ã‚ãªãŸã¯ä»‹è­·ç¾å ´ã®ã‚ã‚‰ã‚†ã‚‹ãƒªã‚¹ã‚¯ã‚’çŸ¥ã‚Šå°½ãã—ãŸã€è¿…é€Ÿã‹ã¤å†·é™ãªåŸ·äº‹å…¼å°‚é–€å®¶ã€Œã‚¸ã‚§ãƒ¼ãƒ ã‚ºã€ã§ã™ã€‚
ä¸»è‡£ã‹ã‚‰å ±å‘Šã•ã‚ŒãŸã€Œ${location}ã€ã§ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆã«å¯¾ã—ã€æ›–æ˜§ãªæ„è­˜è«–ï¼ˆå¾¹åº•ãƒ»åŠªã‚ã‚‹ï¼‰ã‚’ä¸€åˆ‡æ’ã—ã€ä»Šã™ãå®Ÿè¡Œã§ãã‚‹ã€Œå…·ä½“çš„ã‹ã¤ç‰©ç†çš„ãªä»‹å…¥ç­–ã€ã‚’æç¤ºã›ã‚ˆã€‚

ã€ä¸»è‡£ã‹ã‚‰ã®å ±å‘Šã€‘: "${text}"

ã€ã‚¸ã‚§ãƒ¼ãƒ ã‚ºã¸ã®é‰„å‰‡ã€‘:
1. å°‚é–€å®¶ç›®ç·š: å ±å‘Šã®è¡¨é¢çš„ãªè¨€è‘‰ã‚’ãªãã‚‹ã®ã§ã¯ãªãã€ä»‹è­·ã®ãƒ—ãƒ­ã¨ã—ã¦èƒŒå¾Œã®ãƒªã‚¹ã‚¯ã‚’äºˆæ¸¬ã›ã‚ˆã€‚
2. ç‰©ç†çš„ä»‹å…¥ã®ç¾©å‹™: ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆ†ã‘ã‚‹ã€ã€Œæ‰‹ã®å±Šã‹ãªã„ä½ç½®ã«ç½®ãã€ã€Œå€‹åˆ¥èª˜å°ã«ã™ã‚‹ã€ã€Œè‡ªåŠ©å…·ã‚’å¤‰æ›´ã™ã‚‹ã€ç­‰ã®ç‰©ç†çš„å‹•ä½œãƒ»é…ç½®ã®å¤‰æ›´ã‚’å„ªå…ˆã›ã‚ˆã€‚
3. å®šå‹å›ç­”ã®å³ç¦: é¡ä¼¼äº‹è±¡ã§ã‚‚çŠ¶æ³ã«å¿œã˜ãŸç‹¬è‡ªã®å¯¾ç­–ã‚’å‡ºã›ã€‚åŒã˜ã€Œè»¢è½ã€ã§ã‚‚ãƒ™ãƒƒãƒ‰å‘¨å›²ã¨æ¤…å­ã§ã¯ç‰©ç†çš„è¦å› ãŒç•°ãªã‚‹ã€‚
4. ã‚¹ãƒªãƒ åŒ–: å›ç­”ã¯5é …ç›®ã«å³é¸ã›ã‚ˆï¼ˆå…±æœ‰ã¯ä¸è¦ï¼‰ã€‚

ã€å›ç­”å½¢å¼ã€‘:
ä»¥ä¸‹ã®5è¦–ç‚¹ã€ç’°å¢ƒã€‘ã€å£°æ›ã‘ã€‘ã€ç”¨å…·ã€‘ã€è¦‹å®ˆã‚Šã€‘ã€å¿ƒç†ã€‘ã§ã€å„25æ–‡å­—å‰å¾Œã®ç°¡æ½”ãªä¸€è¨€ã§æå‡ºã›ã‚ˆã€‚è¦–ç‚¹åã®ã¿ã‚’è¨˜ã—ã€ç•ªå·ã¯ä¸è¦ã€‚`,
                        user: "carepro-user", response_mode: "blocking"
                    })
                });
                const data = await response.json();
                const solutions = data.answer.split('\n').filter(s => s.length > 5).slice(0, 5);
                displaySolutions(solutions);
            } catch (e) {
                const action = text.includes("è½ã¡") ? "è»¢è½" : text.includes("æ»‘") ? "è»¢å€’" : text.includes("ã‚€ã›") ? "èª¤é£²" : text.includes("é£Ÿã¹") ? "ç•°é£Ÿ/æ¨ªå–ã‚Š" : "å‹•ä½œ";
                let fb = [];
                if (action === "ç•°é£Ÿ/æ¨ªå–ã‚Š") {
                    fb = [
                        `ã€ç’°å¢ƒã€‘ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–“éš”ã‚’ç©ºã‘ã€æ‰‹ã®å±Šã‹ãªã„è·é›¢ã«é…ç½®ã€‚`,
                        `ã€å£°æ›ã‘ã€‘ã€Œã“ã¡ã‚‰ã¯å¾Œã§ã€ã¨å™¨ã‚’é ã–ã‘ã€æ„è­˜ã‚’é€¸ã‚‰ã™ã€‚`,
                        `ã€ç”¨å…·ã€‘å™¨ã®ä¸‹ã«æ»‘ã‚Šæ­¢ã‚ã‚’æ•·ãã€å®‰æ˜“ã«ç§»å‹•ä¸å¯ã«ã™ã‚‹ã€‚`,
                        `ã€è¦‹å®ˆã‚Šã€‘é…è†³æ™‚ã€ç‰¹å®šã®æ–¹ã®æ­£é¢ã«ã¯å¸¸ã«ã‚¹ã‚¿ãƒƒãƒ•ã‚’é…ç½®ã€‚`,
                        `ã€å¿ƒç†ã€‘ã€Œã‚‚ã£ã¨é£Ÿã¹ãŸã„ã€æ¬²æ±‚ã‚’æ±²ã¿ã€ä»£æ›¿å“ã‚’å³åº§ã«æç¤ºã€‚`
                    ];
                } else {
                    fb = [
                        `ã€ç’°å¢ƒã€‘${location}ã®ç‰©ç†çš„å°ç·šã‚’å¤‰æ›´ã—ã€æ¥è§¦ãƒªã‚¹ã‚¯ã‚’æ’é™¤ã€‚`,
                        `ã€å£°æ›ã‘ã€‘å‹•ä½œã«å¯¾ã—ã€Œä¸€æ—¦ã‚¹ãƒˆãƒƒãƒ—ã€ç­‰ã®å…·ä½“çš„æŒ‡ç¤ºã‚’å‡ºã™ã€‚`,
                        `ã€ç”¨å…·ã€‘${action}é˜²æ­¢ã«ç‰¹åŒ–ã—ãŸç¦ç¥‰ç”¨å…·ã¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’æ¤œè¨ã€‚`,
                        `ã€è¦‹å®ˆã‚Šã€‘${action}ç™ºç”Ÿã®ç¬é–“ã‚’äºˆæ¸¬ã€‚é˜²è­·è·é›¢ã‚’ç¢ºå®Ÿã«ä¿æŒã€‚`,
                        `ã€å¿ƒç†ã€‘ç„¦ã‚Šã‚„æˆ¸æƒ‘ã„ã‚’è¦‹æŠœãã€å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹ä»‹å…¥ã‚’å„ªå…ˆã€‚`
                    ];
                }
                displaySolutions(fb);
            }
            loading.style.display = 'none';
        }

        function displaySolutions(solutions) {
            solList.innerHTML = '';
            solutions.forEach(s => {
                const div = document.createElement('div'); div.className = 'sol-item';
                div.innerHTML = `${s}`;
                div.onclick = () => selectSolution(s, div);
                solList.appendChild(div);
            });
            solArea.style.display = 'block';
        }

        customSendBtn.onclick = () => { if (customSolText.value) selectSolution(`ã€ç‹¬è‡ªã€‘${customSolText.value}`, customSendBtn); };

        async function selectSolution(s, el) {
            if (el.classList && el.classList.contains('selected')) return;
            if (el.classList) el.classList.add('selected');
            const data = {
                date: new Date().toLocaleString('ja-JP'),
                time: new Date().getHours() + "æ™‚å°",
                user: selUser.value || 'ä¸æ˜', patient: selPatient.value || 'ä¸æ˜',
                location: selLocation.value || 'ç¾å ´', content: inputText.value, solution: s
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                alert('ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸï¼');
                saveLocalHistory(data);
                solArea.style.display = 'none'; inputText.value = ''; customSolText.value = '';
            } catch (e) { alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
        }

        function saveLocalHistory(data) {
            const history = JSON.parse(localStorage.getItem('care_history') || '[]');
            history.unshift(data);
            localStorage.setItem('care_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('care_history') || '[]');
            if (history.length === 0) return;
            const area = document.getElementById('historyArea');
            area.style.display = 'block';
            document.getElementById('historyList').innerHTML = history.slice(0, 10).map(item => `
            <div style="background:#fff;padding:12px;border-radius:12px;margin-bottom:8px;font-size:12px;border:1px solid #eee;">
                <strong>${item.user}</strong> â†’ <strong>${item.patient}</strong> <small style="float:right">${item.date.split(' ')[1]}</small>
                <div style="color:#666;font-size:11px;">å ±å‘Š: ${item.content}</div>
                <div style="color:var(--accent);font-size:11px;font-weight:bold;">å¯¾ç­–: ${item.solution}</div>
            </div>
        `).join('');
        }

        window.onload = init;
    </script>

    <div id="historyArea">
        <div style="font-size:14px;font-weight:bold;margin-bottom:10px;">ğŸ“ æœ¬æ—¥ã®ç™»éŒ²å±¥æ­´</div>
        <div id="historyList"></div>
    </div>
</body>

</html>