<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Care-Pro2 AI | ä»‹è­·ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆå ±å‘Šæ”¯æ´</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d4af37;
            /* é«˜ç´šæ„Ÿã®ã‚ã‚‹ã‚´ãƒ¼ãƒ«ãƒ‰ */
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .speech-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 30px;
        }

        .btn-record {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-record:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* èªè­˜çµæœã®è¡¨ç¤º */
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .meta-item {
            background: #f1f4f6;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .meta-label {
            font-weight: bold;
            color: #7f8c8d;
            display: block;
            margin-bottom: 4px;
        }

        .content-area {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            min-height: 100px;
            background: #fff;
        }

        /* å¯¾ç­–æ¡ˆã‚«ãƒ¼ãƒ‰ */
        .solutions-grid {
            display: none;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 30px;
        }

        .solution-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--accent);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .solution-card:hover {
            transform: scale(1.02);
            border-left-width: 10px;
        }

        .solution-card.selected {
            background: #f0f7ff;
            border-left-color: #27ae60;
        }

        /* é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ« */
        .analytics-section {
            margin-top: 50px;
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loader {
            display: none;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Care-Pro2 AI</h1>
            <p class="subtitle">ç¾å ´ã®ã€Œä¸æ³¨æ„ãƒ»è¦‹è½ã¨ã—ã€ã‚’é˜²ãæœ€å¼·ã®è¨˜éŒ²æ”¯æ´</p>
        </header>

        <main>
            <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="speech-section">
                <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 20px;">
                    ã‚¹ãƒãƒ›ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã«ã‚ã‚‹ãƒã‚¤ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ ğŸ¤ ã‚’ä½¿ã£ã¦ã€<br>
                    ã€Œäº‹è±¡ã€ã¨ã€Œãƒªã‚¹ã‚¯ã€ã‚’è©±ã—ã¦ãã ã•ã„ã€‚
                </p>

                <div class="metadata-grid">
                    <div class="meta-item">
                        <span class="meta-label">å ±å‘Šæ—¥æ™‚</span>
                        <span id="meta-date">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">å ±å‘Šè€…</span>
                        <span id="meta-user">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">å¯¾è±¡åˆ©ç”¨è€…</span>
                        <span id="meta-patient">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ç™ºç”Ÿå ´æ‰€</span>
                        <span id="meta-location">-</span>
                    </div>
                </div>

                <textarea id="transcript" class="content-area" style="width: 100%; box-sizing: border-box; font-size: 1rem; padding: 15px; border: 1px solid #ddd;" placeholder="ã“ã“ã«å†…å®¹ã‚’å…¥åŠ›ã€ã¾ãŸã¯ã‚¹ãƒãƒ›ã®éŸ³å£°å…¥åŠ›ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„..."></textarea>

                <div style="margin-top: 20px;">
                    <button id="analyzeBtn" class="btn-record">
                        <span>âœ¨</span> è§£æã‚’å®Ÿè¡Œã™ã‚‹
                    </button>
                </div>

                <div id="loader" class="loader"></div>
            </section>

            <!-- å¯¾ç­–æ¡ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section id="solutionsArea">
                <h2 style="text-align: center; color: var(--primary);">AIæ¨å¥¨ã®å¯¾ç­–æ¡ˆ (é¸æŠã—ã¦ãã ã•ã„)</h2>
                <p style="text-align: center; color: #7f8c8d; font-size: 0.9rem;">â€»ãƒ‡ãƒ¢ç‰ˆã®ãŸã‚5ã¤ã®å¯¾ç­–ä¾‹ã‚’è‡ªå‹•è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                <div id="solutionsGrid" class="solutions-grid">
                    <!-- JavaScriptã§ç”Ÿæˆ -->
                </div>
            </section>

            <!-- é›†è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section id="analyticsArea" class="analytics-section">
                <h2 style="text-align: center; color: var(--primary);">æœˆé–“ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆé›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ</h2>
                <table id="analyticsTable">
                    <thead>
                        <tr>
                            <th>æ—¥æ™‚</th>
                            <th>å ±å‘Šè€…</th>
                            <th>åˆ©ç”¨è€…</th>
                            <th>å ´æ‰€</th>
                            <th>äº‹è±¡å†…å®¹</th>
                            <th>æ±ºå®šå¯¾ç­–</th>
                        </tr>
                    </thead>
                    <tbody id="analyticsBody">
                        <!-- ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </tbody>
                </table>
            </section>

            <div style="text-align: center; margin-top: 40px;">
                <button id="toggleBtn" onclick="toggleAnalytics()"
                    style="background:none; border:none; color:var(--primary); cursor:pointer; text-decoration:underline;">
                    é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
                </button>
            </div>
        </main>
    </div>

    <script>
        // Dify APIè¨­å®š
        const API_KEY = 'app-jCYBv1fEqIbe66K9e63iSt3M';
        const DIFY_URL = 'https://api.dify.ai/v1/chat-messages';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyhUG3jpqeSvvw2D0q8J1eeFyA9REWyvHIPOhh1jZ48XRKspNrbeiixdM0_TAKesMFJww/exec';

        let currentData = {
            date: '',
            user: '',
            patient: '',
            location: 'å±…å®¤', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            content: '',
            solution: ''
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¥æ™‚ã‚’ã‚»ãƒƒãƒˆ
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            currentData.date = now.toLocaleString('ja-JP');
            document.getElementById('meta-date').innerText = currentData.date;
        });

        document.getElementById('analyzeBtn').onclick = () => {
            const text = document.getElementById('transcript').value.trim();
            if (!text) {
                alert('å ±å‘Šå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            currentData.content = text;
            processTranscript(text);
        };

        // éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã®è§£æ
        function processTranscript(text) {
            // åå‰ã¨åˆ©ç”¨è€…åã®æŠ½å‡ºï¼ˆã€Œã€‡ã€‡ã§ã™ã€ã€Œã€‡ã€‡ã•ã‚“ã®ã€ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
            const userMatch = text.match(/(.+)ã§ã™/);
            const patientMatch = text.match(/(.+)ã•ã‚“ã®/);

            if (userMatch) currentData.user = userMatch[1].trim();
            if (patientMatch) currentData.patient = patientMatch[1].trim();

            document.getElementById('meta-user').innerText = currentData.user || 'æœªæ¤œçŸ¥';
            document.getElementById('meta-patient').innerText = currentData.patient || 'æœªæ¤œçŸ¥';
            document.getElementById('meta-location').innerText = currentData.location;

            // AIè§£æã®å‘¼ã³å‡ºã—
            callDifyAI(text);
        }

        async function callDifyAI(input) {
            document.getElementById('loader').style.display = 'block';

            try {
                // Dify API å®Ÿè¡Œï¼ˆ5ã¤ã®è¦–ç‚¹ã§å¯¾ç­–æ¡ˆã‚’è¦æ±‚ï¼‰
                const response = await fetch(DIFY_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: {},
                        query: `ä»‹è­·ç¾å ´ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆå ±å‘Šã§ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã«åŸºã¥ãã€ã€ç’°å¢ƒã€‘ã€å£°æ›ã‘ã€‘ã€ç”¨å…·ã€‘ã€è¦‹å®ˆã‚Šã€‘ã€å…±æœ‰ã€‘ã®5ã¤ã®å°‚é–€çš„ãªè¦–ç‚¹ã§ã€å…·ä½“çš„ã‹ã¤ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå¯¾ç­–æ¡ˆã‚’ã€Œãã‚Œãã‚Œ1ã€œ2è¡Œç¨‹åº¦ã€ã§è©³ã—ãæç¤ºã—ã¦ãã ã•ã„ã€‚
                    å ±å‘Šå†…å®¹: ${input}
                    å ±å‘Šè€…: ${currentData.user} / å¯¾è±¡è€…: ${currentData.patient}`,
                        response_mode: "blocking",
                        user: "carepro-user"
                    })
                });

                const data = await response.json();

                // Difyã‹ã‚‰ã®å›ç­”ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒªã‚¹ãƒˆåŒ–
                let solutions = [];
                if (data.answer) {
                    solutions = data.answer.split('\n').filter(line => line.trim().length > 5).slice(0, 5);
                }

                if (solutions.length < 5) {
                    solutions = [
                        "ã€ç’°å¢ƒã€‘å±…å®¤ã®è¶³å…ƒã«ã‚ã‚‹é›»æ°—ã‚³ãƒ¼ãƒ‰ã‚’å£å´ã«å›ºå®šã—ã€æ­©è¡Œæ™‚ã®èº“ããƒªã‚¹ã‚¯ã‚’æ’é™¤ã€‚ç§»å‹•å°ç·šã‚’åºƒã‚ã«ç¢ºä¿ã™ã‚‹ã€‚",
                        "ã€å£°æ›ã‘ã€‘ç«‹ã¡ä¸ŠãŒã‚Šã®éš›ã¯ã€Œä¸€åº¦æ·±å‘¼å¸ã—ã¾ã—ã‚‡ã†ã€ã¨å£°ã‚’ã‹ã‘ã€å‹•ä½œã®æ€¥ãã™ãã‚’æŠ‘åˆ¶ã€‚è½ã¡ç€ã„ãŸè¡Œå‹•ã‚’ä¿ƒã™ã€‚",
                        "ã€ç”¨å…·ã€‘ç¾åœ¨ä½¿ç”¨ä¸­ã®ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ–ãƒ¬ãƒ¼ã‚­ã®åŠ¹ãã‚’ç‚¹æ¤œã€‚å¿…è¦ã«å¿œã˜ã¦æ»‘ã‚Šæ­¢ã‚ã®å†èª¿æ•´ã‚’è¡Œã†ã€‚",
                        "ã€è¦‹å®ˆã‚Šã€‘é›¢åºŠã®å…†å€™ã‚’æ—©æœŸã«æ¤œçŸ¥ã™ã‚‹ãŸã‚ã€äººæ„Ÿã‚»ãƒ³ã‚µãƒ¼ã®é…ç½®è§’åº¦ã‚’ãƒ™ãƒƒãƒ‰ã®ä¸­å¤®å‘ãã«å¾®èª¿æ•´ã™ã‚‹ã€‚",
                        "ã€å…±æœ‰ã€‘æœ¬æ—¥ã®å‡ºæ¥äº‹ã‚’å¤œå‹¤è€…ã¸ã®ç”³ã—é€ã‚Šäº‹é …ã«ã€Œå¤•æ–¹ã®ç«‹ã¡ä¸ŠãŒã‚Šä¸å®‰å®šã€ã¨ã—ã¦æ˜ç¢ºã«è¨˜éŒ²ãƒ»ä¼é”ã™ã‚‹ã€‚"
                    ];
                }

                displaySolutions(solutions);

            } catch (error) {
                console.error('AI API Error:', error);
                const fallback = [
                    "ã€ç’°å¢ƒã€‘è¶³å…ƒã®è·ç‰©ã‚’æ•´ç†ã—ã€å°ç·šã‚’ç¢ºä¿ã™ã‚‹ã€‚æ»‘ã‚Šã‚„ã™ã„ç®‡æ‰€ã®æ¸…æƒã‚’è¡Œã†ã€‚",
                    "ã€å£°æ›ã‘ã€‘å‹•ä½œã®å‰ã«å¿…ãšæ¬¡ã®å‹•ãã‚’èª¬æ˜ã—ã€å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹ã€‚ç„¡ç†ãªå‹•ãã‚’åˆ¶æ­¢ã™ã‚‹ã€‚",
                    "ã€ç”¨å…·ã€‘æ­©è¡Œå™¨ãƒ»è»Šæ¤…å­ã®æ•´å‚™ã‚’å³åº§ã«å®Ÿæ–½ã€‚ç©ºæ°—åœ§ã‚„ãƒ–ãƒ¬ãƒ¼ã‚­ã®ç·©ã¿ã‚’ç¢ºèªã€‚",
                    "ã€è¦‹å®ˆã‚Šã€‘è¨ªå®¤é »åº¦ã‚’ä¸€æ™‚çš„ã«ä¸Šã’ã€çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç¶™ç¶šçš„ã«è¦³å¯Ÿã€‚å¿…è¦ãªã‚‰ã‚»ãƒ³ã‚µãƒ¼ã‚’æ´»ç”¨ã€‚",
                    "ã€å…±æœ‰ã€‘ãƒãƒ¼ãƒ å…¨ä½“ã§ãƒªã‚¹ã‚¯äº‹ä¾‹ã‚’å…±æœ‰ã—ã€ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã€‚ã‚±ã‚¢ãƒãƒã¸ã‚‚å ±å‘Šã€‚"
                ];
                displaySolutions(fallback);
            }
        }

        function displaySolutions(solutions) {
            document.getElementById('loader').style.display = 'none';
            const grid = document.getElementById('solutionsGrid');
            grid.style.display = 'grid';
            grid.innerHTML = '';

            solutions.forEach((sol, index) => {
                const card = document.createElement('div');
                card.className = 'solution-card';
                card.innerHTML = `<strong>è¦–ç‚¹ ${index + 1}</strong><p>${sol}</p>`;
                card.onclick = () => selectSolution(sol, card);
                grid.appendChild(card);
            });

            document.getElementById('solutionsArea').scrollIntoView({ behavior: 'smooth' });
        }

        async function selectSolution(sol, element) {
            document.querySelectorAll('.solution-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');

            currentData.solution = sol;
            await sendToSheet(currentData);
            saveRecordLocal();

            alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®è¨˜éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        }

        async function sendToSheet(data) {
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                console.error('GASé€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function saveRecordLocal() {
            const records = JSON.parse(localStorage.getItem('care_pro_records') || '[]');
            records.push({ ...currentData });
            localStorage.setItem('care_pro_records', JSON.stringify(records));
            updateAnalyticsTable();
        }

        function updateAnalyticsTable() {
            const records = JSON.parse(localStorage.getItem('care_pro_records') || '[]');
            const tableBody = document.getElementById('analyticsBody');
            tableBody.innerHTML = '';

            records.forEach(rec => {
                const row = `<tr>
                <td>${rec.date}</td>
                <td>${rec.user}</td>
                <td>${rec.patient}</td>
                <td>${rec.location}</td>
                <td style="font-size:0.8rem">${rec.content.substring(0, 30)}...</td>
                <td style="font-weight:bold">${rec.solution}</td>
            </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function toggleAnalytics() {
            const area = document.getElementById('analyticsArea');
            const btn = document.getElementById('toggleBtn');
            if (area.style.display === 'none' || area.style.display === '') {
                area.style.display = 'block';
                btn.innerText = 'é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’éè¡¨ç¤º';
                updateAnalyticsTable();
            } else {
                area.style.display = 'none';
                btn.innerText = 'é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º';
            }
        }

        window.onload = updateAnalyticsTable;
    </script>

</body>

</html>
