<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Care-Pro2 AI | ç¾å ´å®Œå…¨å®Ÿå‹•ãƒ»ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #d4af37;
            --bg: #f4f7f9;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .card {
            background: white;
            width: 100%;
            max-width: 550px;
            padding: 25px;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 6px solid var(--accent);
            position: relative;
        }

        .title {
            color: var(--primary);
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sub {
            color: #888;
            font-size: 14px;
            margin-bottom: 25px;
        }

        .input-group {
            background: #fafafa;
            border: 2px solid #eee;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
        }

        textarea {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 17px;
            min-height: 80px;
            resize: none;
            font-family: inherit;
            color: #333;
            outline: none;
        }

        .controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        .btn {
            border: none;
            border-radius: 18px;
            font-weight: bold;
            cursor: pointer;
            padding: 18px;
            font-size: 16px;
            transition: 0.2s;
        }

        #micBtn {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        #micBtn.active {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        #analyzeBtn {
            background: var(--accent);
            color: white;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        #status {
            margin-top: 15px;
            color: var(--accent);
            font-size: 14px;
            font-weight: bold;
            min-height: 20px;
        }

        .loading {
            display: none;
            margin: 25px 0;
            font-weight: bold;
            color: var(--primary);
        }

        .sol-list {
            display: grid;
            gap: 12px;
            margin-top: 25px;
            text-align: left;
        }

        .sol-item {
            background: #fff;
            border-left: 6px solid var(--accent);
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            font-size: 14px;
            line-height: 1.5;
        }

        .sol-item.selected {
            border-left-color: #27ae60;
            background: #f0fff4;
            border-width: 8px;
        }

        .custom-sol {
            margin-top: 15px;
            background: #fff8e1;
            border: 2px dashed #d4af37;
            border-radius: 18px;
            padding: 15px;
        }

        .custom-sol textarea {
            min-height: 50px;
            font-size: 14px;
            border: none;
            background: transparent;
            width: 100%;
            border-bottom: 1px solid #d4af37;
            margin-bottom: 8px;
            outline: none;
        }

        #historyArea {
            width: 100%;
            max-width: 550px;
            margin-top: 30px;
            display: none;
        }
    </style>
</head>

<body>

    <div class="card">
        <div class="title">Care-Pro2 AI</div>
        <div class="sub">ç¾å ´ã®ã€Œä¸æ³¨æ„ãƒ»è¦‹è½ã¨ã—ã€ã‚’é˜²ãæœ€å¼·ã®è¨˜éŒ²æ”¯æ´</div>

        <!-- é¸æŠå…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆ4é …ç›®ã«æ‹¡å¼µï¼‰ -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
            <div>
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">æ‹…å½“è€…</label>
                <select id="selectUser"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                    <option value="">èª­è¾¼ä¸­...</option>
                </select>
            </div>
            <div>
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">å¯¾è±¡åˆ©ç”¨è€…</label>
                <select id="selectPatient"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                    <option value="">èª­è¾¼ä¸­...</option>
                </select>
            </div>
            <div>
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">å ´æ‰€</label>
                <select id="selectLocation"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px;">
                    <option value="">èª­è¾¼ä¸­...</option>
                </select>
            </div>
            <div>
                <label style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">ã‚·ãƒ¼ãƒ³</label>
                <select id="selectScene"
                    style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px; background: #fff8e1; border-color: var(--accent);">
                    <option value="">èª­è¾¼ä¸­...</option>
                </select>
            </div>
        </div>

        <div class="input-group">
            <textarea id="inputText" placeholder="ã€Œè»Šæ¤…å­ã‹ã‚‰ç«‹ã¡ä¸ŠãŒã‚ã†ã¨ã—ã¦æ»‘ã‚Šãã†ã«ãªã£ãŸã€ç­‰ã€äº‹è±¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
        </div>

        <div class="controls">
            <button id="micBtn" class="btn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
            <button id="analyzeBtn" class="btn">è§£æ</button>
        </div>

        <div id="status"></div>
        <div id="loading" class="loading">ã‚¸ã‚§ãƒ¼ãƒ ã‚ºãŒç¾å ´ã®çœŸå®Ÿã‚’åˆ†æä¸­...</div>

        <div id="solArea" style="display:none;">
            <div id="solList" class="sol-list"></div>

            <div class="custom-sol">
                <div style="font-size: 12px; font-weight: bold; color: var(--accent); margin-bottom: 5px;">ğŸ“
                    ç¾å ´ç‹¬è‡ªã®å¯¾ç­–ï¼ˆè‡ªç”±å…¥åŠ›ãƒ»éŸ³å£°å¯ï¼‰</div>
                <textarea id="customSolText" placeholder="ç¾å ´ã§æ±ºã‚ãŸå³å¿œå¯¾ç­–ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                <button id="customSendBtn" class="btn"
                    style="width:100%; padding: 10px; background: #27ae60; color: white;">ã“ã®å†…å®¹ã§ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwO0Ssrwf3UIC_hlAMcFke0RSNGpmlDyL-jRnCvN_i_uIDImf0tn52qhgbWW0WHPpuwSQ/exec';
        const API_KEY = 'app-v1I9QtYzxp4MHeoJN3yLRW5k';
        const DIFY_URL = 'https://api.dify.ai/v1/chat-messages';

        const micBtn = document.getElementById('micBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const inputText = document.getElementById('inputText');
        const customSolText = document.getElementById('customSolText');
        const customSendBtn = document.getElementById('customSendBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const solArea = document.getElementById('solArea');
        const solList = document.getElementById('solList');
        const selUser = document.getElementById('selectUser');
        const selPatient = document.getElementById('selectPatient');
        const selLocation = document.getElementById('selectLocation');
        const selScene = document.getElementById('selectScene');

        let recognition, isRecording = false;

        async function init() {
            renderHistory();
            status.innerText = 'ã‚·ãƒ¼ãƒˆåŒæœŸä¸­...';
            try {
                const res = await fetch(`${GAS_URL}?type=master&t=${Date.now()}`);
                const data = await res.json();
                if (data.users && data.users.length > 0) {
                    updateSelect(selUser, data.users, 'æ‹…å½“è€…');
                    updateSelect(selPatient, data.patients, 'åˆ©ç”¨è€…');
                    updateSelect(selLocation, data.locations, 'å ´æ‰€');
                    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®ã‚·ãƒ¼ãƒ³èª­ã¿è¾¼ã¿ã«å¯¾å¿œ
                    if (data.scenes && data.scenes.length > 0) {
                        updateSelect(selScene, data.scenes, 'ã‚·ãƒ¼ãƒ³ã‚’é¸æŠ');
                    }
                    status.innerText = 'ã‚·ãƒ¼ãƒˆåŒæœŸå®Œäº†';
                }
            } catch (e) { status.innerText = 'åŒæœŸå¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ›´æ–°ã—ã¦ãã ã•ã„ï¼‰'; }
        }

        function updateSelect(el, list, placeholder) {
            el.innerHTML = `<option value="">${placeholder}</option>`;
            list.forEach(item => {
                const opt = document.createElement('option');
                opt.value = opt.innerText = item;
                el.appendChild(opt);
            });
        }

        function setupRecognition() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) return null;
            const rec = new Speech();
            rec.lang = 'ja-JP'; rec.interimResults = true; rec.continuous = false;
            rec.onstart = () => { isRecording = true; micBtn.classList.add('active'); status.innerText = 'èãå–ã‚Šä¸­...'; };
            rec.onresult = (e) => {
                let t = ''; for (let i = e.resultIndex; i < e.results.length; i++) { t += e.results[i][0].transcript; }
                if (solArea.style.display === 'block') customSolText.value = t; else inputText.value = t;
            };
            rec.onend = () => {
                isRecording = false; micBtn.classList.remove('active');
                if (solArea.style.display !== 'block' && inputText.value.length > 0) analyze();
            };
            return rec;
        }

        micBtn.addEventListener('click', () => {
            if (!recognition) recognition = setupRecognition();
            if (isRecording) recognition.stop(); else recognition.start();
        });

        analyzeBtn.addEventListener('click', () => { if (inputText.value.length > 0) analyze(); });

        async function analyze() {
            loading.style.display = 'block'; solArea.style.display = 'none'; status.innerText = '';
            const text = inputText.value;
            const location = selLocation.value || "ç¾å ´";
            const scene = selScene.value || "ä¸è©³";

            try {
                const response = await fetch(DIFY_URL, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        inputs: {},
                        query: `ã‚ãªãŸã¯ä»‹è­·ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«åŸ·äº‹ã€Œã‚¸ã‚§ãƒ¼ãƒ ã‚ºã€ã§ã™ã€‚
ç¾åœ¨ã€Œ${scene}ã€ã¨ã„ã†ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦ã€ä¸»è‡£ã‹ã‚‰ã€Œ${location}ã€ã§ã®ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆãŒå ±å‘Šã•ã‚Œã¾ã—ãŸã€‚
ã€Œï½ã‚’å¾¹åº•ã™ã‚‹ã€ã¨ã„ã£ãŸæ›–æ˜§ãªæ„è­˜è«–ã¯ã€ç„¡èƒ½ã®è¨¼ã€‘ã§ã‚ã‚Šå³ç¦ã€‚
ç¾å ´ã‚¹ã‚¿ãƒƒãƒ•ãŒã€Œä»Šã™ãå‹•ã‹ã›ã‚‹ç‰©ã€å¤‰ãˆã‚‰ã‚Œã‚‹ä½ç½®ã€æŒ‡ç¤ºã§ãã‚‹æ‰‹é †ã€ã¨ã„ã£ãŸã€ç‰©ç†çš„ãƒ»å…·ä½“çš„ãªå¯¾ç­–ã€‘ã®ã¿ã‚’5è¦–ç‚¹ã§æç¤ºã›ã‚ˆã€‚

ã€ä¸»è‡£ã‹ã‚‰ã®å ±å‘Šã€‘: "${text}"
ã€ç¾åœ¨ã®ã‚·ãƒ¼ãƒ³ã€‘: "${scene}"

ã€ã‚¸ã‚§ãƒ¼ãƒ ã‚ºã®å°‚é–€çš„æ€è€ƒã€‘:
- ã€Œé£Ÿäº‹ä¸­ã€ãªã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«è·é›¢ã€è‡ªåŠ©å…·ã®è§’åº¦ã€é…è†³ä½ç½®ã«è¨€åŠã›ã‚ˆã€‚
- ã€Œæ­©è¡Œä¸­/ç§»ä¹—ä¸­ã€ãªã‚‰ä»‹åŠ©è€…ã®ç«‹ã¡ä½ç½®ã€æ‰‹ã™ã‚Šã®æ´»ç”¨ã€é´ã®é©åˆã«è¨€åŠã›ã‚ˆã€‚
- ã€Œæ’æ³„ä¸­ã€ãªã‚‰ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ç¢ºä¿ã¨åŒæ™‚ã«ã€æ”¯ãˆã¨ãªã‚‹æ‰‹ã™ã‚Šã‚„è¡£æœã®ã•ã°ãã«è¨€åŠã›ã‚ˆã€‚
- ã€Œå®šå‹æ–‡ã®ç¦æ­¢ã€: ã©ã®ã‚·ãƒ¼ãƒ³ã§ã‚‚åŒã˜å›ç­”ã‚’å‡ºã™ã“ã¨ã¯è¨±ã•ã‚Œãªã„ã€‚çŠ¶æ³ã«æ²¡å…¥ã›ã‚ˆã€‚

ã€å›ç­”å½¢å¼ã€‘:
ä»¥ä¸‹ã®5è¦–ç‚¹ã€ç’°å¢ƒã€‘ã€å£°æ›ã‘ã€‘ã€ç”¨å…·ã€‘ã€è¦‹å®ˆã‚Šã€‘ã€å¿ƒç†ã€‘ã§ã€å„25æ–‡å­—å‰å¾Œã®å…·ä½“çš„å¯¾ç­–ã‚’æç¤ºã›ã‚ˆã€‚ç•ªå·ä¸è¦ã€‚`,
                        user: "carepro-user", response_mode: "blocking"
                    })
                });
                const data = await response.json();
                const solutions = data.answer.split('\n').filter(s => s.length > 5).slice(0, 5);
                displaySolutions(solutions);
            } catch (e) {
                const fb = [
                    `ã€ç’°å¢ƒã€‘ãƒ†ãƒ¼ãƒ–ãƒ«é–“éš”ã‚’ç©ºã‘ã€æ‰‹ã®å±Šã‹ãªã„è·é›¢ã«é…ç½®å¤‰æ›´ã€‚`,
                    `ã€å£°æ›ã‘ã€‘ã€Œã‚†ã£ãã‚Šå™›ã‚“ã§ã€ç­‰ã€å‹•ä½œã‚’å°åˆ†ã‘ã«ã—ãŸå…·ä½“çš„æŒ‡ç¤ºã€‚`,
                    `ã€ç”¨å…·ã€‘å™¨ã®ä¸‹ã«æ»‘ã‚Šæ­¢ã‚ã€‚å®‰æ˜“ã«ç§»å‹•ä¸å¯ãªé‡ã„é£Ÿå™¨ã‚’é¸æŠã€‚`,
                    `ã€è¦‹å®ˆã‚Šã€‘å¸¸ã«æ­£é¢ã¾ãŸã¯æ­»è§’ã¨ãªã‚‰ãªã„æ–œã‚å‰ã«ã‚¹ã‚¿ãƒƒãƒ•é…ç½®ã€‚`,
                    `ã€å¿ƒç†ã€‘æ—©é£Ÿã„ã®æ¬²æ±‚ã‚’å¯ŸçŸ¥ã—ã€ä»£æ›¿å“ã‚„èŒ¶ã‚’é©å®œæä¾›ã€‚`
                ];
                displaySolutions(fb);
            }
            loading.style.display = 'none';
        }

        function displaySolutions(solutions) {
            solList.innerHTML = '';
            solutions.forEach(s => {
                const div = document.createElement('div'); div.className = 'sol-item';
                div.innerHTML = `${s}`;
                div.onclick = () => selectSolution(s, div);
                solList.appendChild(div);
            });
            solArea.style.display = 'block';
        }

        customSendBtn.onclick = () => { if (customSolText.value) selectSolution(`ã€ç‹¬è‡ªã€‘${customSolText.value}`, customSendBtn); };

        async function selectSolution(s, el) {
            if (el.classList && el.classList.contains('selected')) return;
            if (el.classList) el.classList.add('selected');
            const data = {
                date: new Date().toLocaleString('ja-JP'),
                time: new Date().getHours() + "æ™‚å°",
                user: selUser.value || 'ä¸æ˜', patient: selPatient.value || 'ä¸æ˜',
                location: selLocation.value || 'ç¾å ´', scene: selScene.value || 'ä¸è©³',
                content: inputText.value, solution: s
            };
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                alert('ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸï¼');
                saveLocalHistory(data);
                solArea.style.display = 'none'; inputText.value = ''; customSolText.value = '';
            } catch (e) { alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); }
        }

        function saveLocalHistory(data) {
            const history = JSON.parse(localStorage.getItem('care_history') || '[]');
            history.unshift(data);
            localStorage.setItem('care_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('care_history') || '[]');
            if (history.length === 0) return;
            const area = document.getElementById('historyArea');
            area.style.display = 'block';
            document.getElementById('historyList').innerHTML = history.slice(0, 10).map(item => `
            <div style="background:#fff;padding:12px;border-radius:12px;margin-bottom:8px;font-size:12px;border:1px solid #eee;">
                <strong>${item.user}</strong> â†’ <strong>${item.patient}</strong> <small style="float:right">${item.date.split(' ')[1]}</small>
                <div style="color:#888;font-size:10px;">ã‚·ãƒ¼ãƒ³: ${item.scene || 'ä¸è©³'} / å ´æ‰€: ${item.location}</div>
                <div style="color:#666;font-size:11px;">å ±å‘Š: ${item.content}</div>
                <div style="color:var(--accent);font-size:11px;font-weight:bold;">å¯¾ç­–: ${item.solution}</div>
            </div>
        `).join('');
        }

        window.onload = init;
    </script>

    <div id="historyArea">
        <div style="font-size:14px;font-weight:bold;margin-bottom:10px;">ğŸ“ æœ¬æ—¥ã®ç™»éŒ²å±¥æ­´</div>
        <div id="historyList"></div>
    </div>
<div id="debugLog" style="position:fixed;bottom:0;left:0;width:100%;max-height:150px;overflow-y:auto;background:rgba(0,0,0,0.8);color:#0f0;font-size:10px;z-index:9999;display:none;padding:5px;font-family:monospace;"></div><script>window.onerror=function(m,s,l,c,e){document.getElementById("debugLog").style.display="block";document.getElementById("debugLog").innerHTML+="[ERROR] "+m+"<br>";};const originalFetch=window.fetch;window.fetch=async(...args)=>{const res=await originalFetch(...args);if(args[0].includes("dify.ai")){const clone=res.clone();const text=await clone.text();document.getElementById("debugLog").style.display="block";document.getElementById("debugLog").innerHTML+="[Dify Response] "+res.status+" "+text.substring(0,100)+"...<br>";}return res;};</script></body>

</html>